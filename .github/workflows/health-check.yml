name: Health Check

on:
  schedule:
    # Run every 5 minutes
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  health-check:
    name: Check Site Health
    runs-on: ubuntu-latest

    steps:
      - name: Check site availability
        run: |
          # Check main site
          echo "Checking main site..."
          site_response=$(curl -sL -o /dev/null -w "%{http_code}" https://rannegerodias.com || echo "000")
          echo "Main site: HTTP $site_response"
          
          # Check health endpoint
          echo "Checking health endpoint..."
          health_response=$(curl -sL -o /dev/null -w "%{http_code}" https://rannegerodias.com/api/health || echo "000")
          echo "Health endpoint: HTTP $health_response"
          
          # Also try the health.json static file as fallback
          echo "Checking health.json fallback..."
          health_json_response=$(curl -sL -o /dev/null -w "%{http_code}" https://rannegerodias.com/api/health.json || echo "000")
          echo "Health JSON: HTTP $health_json_response"
          
          # Accept 200 or 301/302 (redirects) as OK for main site
          if [ "$site_response" != "200" ] && [ "$site_response" != "301" ] && [ "$site_response" != "302" ]; then
            echo "‚ùå Main site check failed: HTTP $site_response"
            exit 1
          fi
          
          # Health endpoint should return 200
          if [ "$health_response" != "200" ] && [ "$health_json_response" != "200" ]; then
            echo "‚ö†Ô∏è  Warning: Health endpoint returned HTTP $health_response (fallback: $health_json_response)"
            echo "This may be expected if the API endpoint is not yet deployed."
            # Don't fail the workflow for this, just warn
          else
            # Determine which health endpoint succeeded
            if [ "$health_response" == "200" ]; then
              health_status="Health endpoint (HTTP $health_response)"
            elif [ "$health_json_response" == "200" ]; then
              health_status="Health endpoint (fallback, HTTP $health_json_response)"
            else
              health_status="Health endpoint (HTTP $health_response, fallback: HTTP $health_json_response)"
            fi
            echo "‚úÖ Site is healthy: Main site (HTTP $site_response), $health_status"
          fi

      - name: Check Core Web Vitals
        run: |
          # Add Lighthouse CI or similar here
          echo "Core Web Vitals check would run here"

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const runId = context.runId;
            const runUrl = `https://github.com/${owner}/${repo}/actions/runs/${runId}`;
            
            console.log(`‚ùå Health check failed for rannegerodias.com`);
            console.log(`üîó Workflow run: ${runUrl}`);
            console.log(`üìÖ Time: ${new Date().toISOString()}`);
            console.log(`\nüí° Next steps:`);
            console.log(`1. Check Vercel deployment status`);
            console.log(`2. Verify DNS configuration`);
            console.log(`3. Check domain is properly connected to Vercel`);
            console.log(`4. Review deployment logs`);
            
            // You can add actual notifications here:
            // - Create GitHub issue
            // - Send Slack/email notification
            // - Update status badge

