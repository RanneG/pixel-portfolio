name: Enforce Branch Protection

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  check-protection:
    name: Verify Branch Protection Rules
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need at least 2 commits to check for merge commit
      
      - name: Check if push is from PR merge
        run: |
          # Check if this is a merge commit (has multiple parents)
          # Merge commits from PRs will have 2+ parents
          COMMIT_SHA="${{ github.event.head_commit.id }}"
          
          # Get commit message
          COMMIT_MSG=$(git log -1 --format=%B $COMMIT_SHA)
          
          # Check if commit has multiple parents (merge commit)
          PARENTS=$(git show --format=%P --no-patch $COMMIT_SHA)
          
          # Count parents by splitting on spaces
          if [ -z "$PARENTS" ]; then
            PARENT_COUNT=0
          else
            # Replace spaces with newlines and count lines
            PARENT_COUNT=$(echo "$PARENTS" | tr ' ' '\n' | grep -c . || echo "1")
          fi
          
          # Check various indicators of a merged PR
          IS_MERGE_COMMIT=false
          IS_MERGED_PR=false
          
          # Check if it's a merge commit (2+ parents)
          if [ "$PARENT_COUNT" -gt 1 ]; then
            IS_MERGE_COMMIT=true
          fi
          
          # Check commit message for merge patterns
          if echo "$COMMIT_MSG" | grep -qE "^(Merge pull request|Merge branch|Merge commit)"; then
            IS_MERGED_PR=true
          fi
          
          # Check for squash merge patterns (GitHub squash merges often have PR number)
          # Note: Using [0-9] instead of \d because grep -E uses ERE where \d has no special meaning
          if echo "$COMMIT_MSG" | grep -qE "\(#[0-9]+\)"; then
            IS_MERGED_PR=true
          fi
          
          # Allow merge commits and commits with merge patterns
          if [ "$IS_MERGE_COMMIT" = true ] || [ "$IS_MERGED_PR" = true ]; then
            echo "‚úÖ Push is from merged PR (allowed)"
            if [ "$IS_MERGE_COMMIT" = true ]; then
              echo "   Reason: Merge commit detected ($PARENT_COUNT parents)"
            else
              echo "   Reason: Merge pattern detected in commit message"
            fi
          elif echo "$COMMIT_MSG" | grep -qE "^(Revert|\(cherry picked from)"; then
            echo "‚úÖ Push is from revert or cherry-pick (allowed)"
          else
            echo "‚ùå Direct push to main branch detected!"
            echo "‚ö†Ô∏è  Main branch is protected. Please use pull requests."
            echo "üìù Create a branch and submit a PR instead."
            echo ""
            echo "Commit details:"
            echo "  SHA: $COMMIT_SHA"
            echo "  Author: ${{ github.event.head_commit.author.name }}"
            echo "  Parents: $PARENT_COUNT"
            echo "  Message: $(echo "$COMMIT_MSG" | head -1)"
            exit 1
          fi

  validate-pr:
    name: Validate Pull Request
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR requirements
        run: |
          echo "## üìã Pull Request Validation"
          echo ""
          echo "**PR:** #${{ github.event.pull_request.number }}"
          echo "**Author:** ${{ github.event.pull_request.user.login }}"
          echo "**Base:** ${{ github.event.pull_request.base.ref }}"
          echo "**Head:** ${{ github.event.pull_request.head.ref }}"
          echo ""
          
          # Check if PR is targeting main
          if [ "${{ github.event.pull_request.base.ref }}" != "main" ]; then
            echo "‚ö†Ô∏è  Warning: This PR is not targeting main branch"
          fi
          
          # Check if PR has description
          if [ -z "${{ github.event.pull_request.body }}" ]; then
            echo "‚ö†Ô∏è  Warning: PR description is empty"
          else
            echo "‚úÖ PR has description"
          fi
          
          # Check if PR is draft
          if [ "${{ github.event.pull_request.draft }}" == "true" ]; then
            echo "‚ÑπÔ∏è  This is a draft PR"
          fi
          
          echo ""
          echo "**Status:** Ready for review ‚úÖ"

      - name: Check for breaking changes
        run: |
          # Check commit messages for breaking changes
          COMMITS=$(git log ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} --pretty=format:"%s")
          
          if echo "$COMMITS" | grep -qi "BREAKING CHANGE\|BREAKING:"; then
            echo "‚ö†Ô∏è  Breaking changes detected in commits!"
            echo "Please ensure PR description clearly documents breaking changes."
          fi

      - name: Validate file changes
        run: |
          # Check for sensitive files
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})
          
          SENSITIVE_FILES=(".env" "secrets" "credentials")
          for file in $CHANGED_FILES; do
            for sensitive in "${SENSITIVE_FILES[@]}"; do
              if [[ "$file" == *"$sensitive"* ]]; then
                echo "‚ùå Error: Sensitive file detected: $file"
                echo "Please remove sensitive files from PR"
                exit 1
              fi
            done
          done
          
          echo "‚úÖ No sensitive files detected"

